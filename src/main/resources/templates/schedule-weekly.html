<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Расписание занятий</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { padding-top: 70px; background-color: #f8f9fa; }
        .schedule-grid { border-collapse: collapse; width: 100%; table-layout: fixed; margin-top: 1rem; background-color: #fff; }
        .schedule-grid th, .schedule-grid td { border: 1px solid #dee2e6; padding: 0.4rem; text-align: center; vertical-align: top; height: 90px; font-size: 0.85em; position: relative; }
        .schedule-grid th { background-color: #e9ecef; font-weight: 500; }
        .schedule-grid .time-header { width: 70px; font-weight: bold; background-color: #e9ecef; vertical-align: middle; font-size: 0.8em; }
        .entry { font-size: 0.9em; margin-bottom: 3px; padding: 4px; border-radius: 4px; background-color: #e7f1ff; border: 1px solid #b8d6ff; text-align: left; line-height: 1.25; overflow: hidden; word-wrap: break-word; }
        .entry .entry-time { font-weight: 500; color: #0d6efd; margin-bottom: 2px; display: block; font-size: 0.9em;}
        .entry .entry-subject { font-weight: 600; color: #212529; display: block; margin-bottom: 1px;}
        .entry .entry-details { color: #495057; display: block; font-size: 0.85em; }
        .entry .entry-details small { font-size: 0.9em; }
        .entry-actions { position: absolute; bottom: 2px; right: 2px; opacity: 0; transition: opacity 0.2s ease-in-out; }
        td:hover .entry-actions { opacity: 1; }
        .entry-actions .btn { padding: 0.1rem 0.3rem; font-size: 0.8em; line-height: 1; }
        .week-nav { background-color: #fff; padding: 0.75rem 1rem; border-radius: 0.375rem; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075); margin-bottom: 1rem;}
        .week-nav span { font-size: 1.1em; font-weight: 500; }
        .filter-form { background-color: #fff; padding: 1rem; border-radius: 0.375rem; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075); margin-bottom: 1rem;}
        .logout-form button { background: none!important; border: none; padding: 0!important; color: rgba(255,255,255,.55); text-decoration: none; cursor: pointer; display: inline; }
        .logout-form button:hover { text-decoration: underline; color: rgba(255,255,255,.75); }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/schedule}">
            <i class="bi bi-calendar-week"></i> UniversitySchedule
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" th:classappend="${isSchedulePageActive} ? 'active' : ''" th:href="@{/schedule}">Основное расписание</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:classappend="${isExamsPageActive} ? 'active' : ''" th:href="@{/exams}">Расписание экзаменов</a>
                </li>
            </ul>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item" sec:authorize="isAuthenticated()">
                     <span class="navbar-text me-3">
                        <i class="bi bi-person-circle"></i>
                        <span sec:authentication="principal.username">Username</span>
                     </span>
                </li>
                <li class="nav-item" sec:authorize="isAuthenticated()">
                    <form th:action="@{/logout}" method="post" class="logout-form d-flex">
                        <button type="submit" class="nav-link" style="color: rgba(255,255,255,.55);">
                            <i class="bi bi-box-arrow-right"></i> Выйти
                        </button>
                    </form>
                </li>
                <li class="nav-item" sec:authorize="!isAuthenticated()">
                    <a class="nav-link" th:href="@{/login}">
                        <i class="bi bi-box-arrow-in-right"></i> Войти
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid mt-4">

    <div class="filter-form mb-3">
        <p class="text-muted">Форма для фильтров по году/семестру/неделе будет здесь.</p>
    </div>

    <div class="d-flex justify-content-between align-items-center week-nav">
        <a th:href="@{/schedule(calendarWeek=${currentWeekStart.minusWeeks(1)})}" class="btn btn-outline-primary btn-sm">&lt; Пред.</a>
        <span class="h5 mb-0 mx-3" th:text="${#temporals.format(currentWeekStart, 'dd.MM.yyyy')} + ' - ' + ${#temporals.format(currentWeekStart.plusDays(6), 'dd.MM.yyyy')}">Дата недели</span>
        <a th:href="@{/schedule(calendarWeek=${currentWeekStart.plusWeeks(1)})}" class="btn btn-outline-primary btn-sm">След. &gt;</a>
    </div>

    <div sec:authorize="hasRole('ADMIN')" class="mb-3 text-end">
    </div>

    <div class="table-responsive shadow-sm bg-white rounded">
        <table class="schedule-grid">
            <thead>
            <tr>
                <th class="time-header"><i class="bi bi-clock"></i></th> <th th:each="day : ${weekDates}"
                                                                             th:text="${#strings.capitalize(day.dayOfWeek.getDisplayName(T(java.time.format.TextStyle).SHORT_STANDALONE, locale))} + ' ' + ${#temporals.format(day, 'dd.MM')}">
                День (Дата)
            </th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${timeSlots.isEmpty()}">
                <td colspan="8" class="text-center p-5">Временные слоты не определены.</td>
            </tr>
            <tr th:each="slot : ${timeSlots}">
                <td class="time-header" th:text="${#temporals.format(slot, 'HH:mm')}">08:00</td>
                <td th:each="day : ${weekDates}" style="position: relative;">
                    <div th:if="${scheduleMap.containsKey(day) and scheduleMap.get(day).containsKey(slot.withMinute(0).withSecond(0).withNano(0))}">
                        <div th:each="entry : ${scheduleMap.get(day).get(slot.withMinute(0).withSecond(0).withNano(0))}" class="entry position-relative">
                            <span class="entry-time" th:text="${#temporals.format(entry.startTime, 'HH:mm')} + '-' + ${#temporals.format(entry.endTime, 'HH:mm')}"></span>
                            <span class="entry-subject" th:text="${entry.subjectName}"></span>
                            <span class="entry-details">
                                <span th:if="${entry.teacherName}" th:text="${entry.teacherName}"></span>
                                <span th:if="${entry.room}" th:text="' / Ауд: ' + ${entry.room}"></span>
                                <small th:if="${entry.academicYear}" class="d-block text-muted"
                                       th:text="'(' + ${entry.academicYear} + ', С' + ${entry.semester} + ', Н' + ${entry.weekNumber} + ')'"></small>
                            </span>
                        </div>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <div th:if="${entries == null or entries.isEmpty()}" class="alert alert-secondary mt-3" role="alert">
        На отображаемой неделе записей в расписании нет.
    </div>

</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>