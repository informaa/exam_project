<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</title>
    <link rel="stylesheet" th:href="@{/css/schedule-generate-style.css}">
</head>
<body>

<header class="admin-page-header">
    <div class="header-logo-title">
        <a th:href="@{/admin}" class="page-logo-link"><span class="page-logo">Admin<span>Panel</span></span></a>
    </div>
    <div class="header-user-controls" sec:authorize="isAuthenticated()">
        <span class="username" sec:authentication="principal.username">User</span>
        <form th:action="@{/logout}" method="post" style="display: inline; margin-left: 15px;">
            <button type="submit" class="button-logout">–í—ã–π—Ç–∏</button>
        </form>
    </div>
</header>

<main class="admin-content-wrapper">
    <div class="content-card">
        <div class="page-section-header">
            <h1>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h1>
        </div>

        <div th:if="${successMessage}" class="message success-message">
            <span class="icon" style="margin-right:8px;">üéâ</span> <span th:text="${successMessage}"></span>
        </div>
        <div th:if="${errorMessage}" class="message error-message">
            <span class="icon" style="margin-right:8px;">‚ùó</span> <span th:text="${errorMessage}"></span>
        </div>

        <form th:action="@{/schedule/generate}" method="post">

            <div class="form-step-card">
                <h3><span class="icon">üóìÔ∏è</span>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h3>
                <div class="form-group">
                    <label for="academicYear">–£—á–µ–±–Ω—ã–π –≥–æ–¥:</label>
                    <select id="academicYear" name="academicYear" class="form-control" th:value="${selectedAcademicYear}">
                        <option th:each="year : ${academicYears}" th:value="${year}" th:text="${year}" th:selected="${year == selectedAcademicYear}"></option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="semester">–°–µ–º–µ—Å—Ç—Ä:</label>
                    <select id="semester" name="semester" class="form-control" th:value="${selectedSemester}">
                        <option th:each="sem : ${semesters}" th:value="${sem}" th:text="${sem + ' —Å–µ–º–µ—Å—Ç—Ä'}" th:selected="${sem == selectedSemester}"></option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="lessonsPerDay">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä –≤ –¥–µ–Ω—å:</label>
                    <input type="number" id="lessonsPerDay" name="lessonsPerDay" class="form-control" min="1" max="8" th:value="${selectedLessonsPerDay ?: 6}" required>
                </div>

                <div class="form-group">
                    <label>–£—á–µ–±–Ω—ã–µ –¥–Ω–∏ –≤ –Ω–µ–¥–µ–ª–µ:</label>
                    <div class="checkbox-group">
                        <th:block th:each="day : ${daysOfWeek}">
                            <label class="checkbox-label" th:for="${'day_' + day.name()}">
                                <input type="checkbox" th:id="${'day_' + day.name()}" name="selectedWorkingDaysStr" th:value="${day.name()}"
                                       th:checked="${preSelectedWorkingDays != null and #lists.contains(preSelectedWorkingDays, day.name())}" />
                                <span th:text="${day.getDisplayName(T(java.time.format.TextStyle).FULL, T(java.util.Locale).forLanguageTag('ru'))}"></span>
                            </label>
                        </th:block>
                    </div>
                </div>
            </div>

            <div class="form-step-card">
                <h3><span class="icon">üìö</span>–ü—Ä–µ–¥–º–µ—Ç—ã –¥–ª—è —Å–µ–º–µ—Å—Ç—Ä–∞</h3>
                <div class="form-group">
                    <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <div class="subject-selection-grid">
                        <th:block th:each="subject : ${allSubjects}">
                            <label class="subject-card" th:for="${'subject-id-' + subject.id}"
                                   th:classappend="${subject.teacher == null ? 'no-teacher-warning' : ''}">
                                <input type="checkbox"
                                       name="subjectIds"
                                       th:id="${'subject-id-' + subject.id}"
                                       th:value="${subject.id}"
                                       th:checked="${preSelectedSubjectIds != null and #lists.contains(preSelectedSubjectIds, subject.id)}"
                                       class="subject-card-checkbox">
                                <div class="subject-card-content">
                                    <h4 class="subject-card-name" th:text="${subject.name}">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞</h4>
                                    <p class="subject-card-teacher"
                                       th:if="${subject.teacher != null}"
                                       th:text="${subject.teacher.fullName}">
                                        –ò–º—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
                                    </p>
                                    <p class="subject-card-teacher no-teacher-text"
                                       th:if="${subject.teacher == null}">
                                        ‚ö†Ô∏è –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω!
                                    </p>
                                    <span class="subject-card-credits" th:text="${subject.credits + ' –∫—Ä–µ–¥–∏—Ç–∞(–æ–≤)'}"></span>
                                </div>
                                <span class="subject-card-checkmark-overlay">
                                        <span class="checkmark-icon">‚úî</span>
                                    </span>
                            </label>
                        </th:block>
                    </div>
                    <small th:if="${allSubjects == null or #lists.isEmpty(allSubjects)}" class="message error-message" style="margin-top:15px; display:block;">
                        –°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –ø—É—Å—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã –≤ —Å–∏—Å—Ç–µ–º—É.
                    </small>
                    <small id="subjectSelectionError" class="message error-message" style="display:none; margin-top:15px;">
                        –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–µ–¥–º–µ—Ç.
                    </small>
                </div>
            </div>
            <div class="form-step-card">
                <h3><span class="icon">‚öôÔ∏è</span>–û–ø—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</h3>
                <div class="form-group">
                    <label class="checkbox-label" for="repeatWeeklyThroughoutSemester">
                        <input type="checkbox" id="repeatWeeklyThroughoutSemester" name="repeatWeeklyThroughoutSemester" value="true" th:checked="${preRepeatWeekly}">
                        –ü–æ–≤—Ç–æ—Ä—è—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –Ω–µ–¥–µ–ª—é –Ω–∞ –≤–µ—Å—å —Å–µ–º–µ—Å—Ç—Ä
                    </label>
                    <p style="font-size:0.9em; color: var(--light-text); margin-top: 8px; padding-left: 30px;">
                        –ï—Å–ª–∏ –∑–∞–Ω—è—Ç–∏—è –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ, –≤—ã–±–µ—Ä–∏—Ç–µ —ç—Ç—É –æ–ø—Ü–∏—é. –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω —à–∞–±–ª–æ–Ω –Ω–∞ –æ–¥–Ω—É –Ω–µ–¥–µ–ª—é –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω –∫–æ –≤—Å–µ–º –Ω–µ–¥–µ–ª—è–º —Å–µ–º–µ—Å—Ç—Ä–∞.
                    </p>
                </div>
            </div>

            <div class="form-step-card">
                <h3><span class="icon">üîî</span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤</h3>
                <div class="form-group">
                    <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ä—ã: <strong th:text="${lessonDuration + ' –º–∏–Ω—É—Ç'}"></strong></label>
                    <table class="bell-schedule-table">
                        <thead><tr><th>–ü–∞—Ä–∞ ‚Ññ</th><th>–ù–∞—á–∞–ª–æ</th><th>–ö–æ–Ω–µ—Ü</th></tr></thead>
                        <tbody>
                        <tr th:each="lessonNumEntry : ${lessonStartTimes}">
                            <td th:text="${lessonNumEntry.key}"></td>
                            <td th:text="${#temporals.format(lessonNumEntry.value, 'HH:mm')}"></td>
                            <td th:text="${#temporals.format(lessonNumEntry.value.plusMinutes(lessonDuration), 'HH:mm')}"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="button-primary" onclick="return confirmSubmit(event);">
                    <span class="icon"></span>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
                </button>
                <a th:href="@{/admin}" class="button-secondary">
                    <span class="icon"></span>–ù–∞–∑–∞–¥
                </a>
            </div>
        </form>
    </div>
</main>
<script>
    function confirmSubmit(event) {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
        const selectedSubjects = document.querySelectorAll('input[name="subjectIds"]:checked').length;
        const subjectError = document.getElementById('subjectSelectionError');
        if (selectedSubjects === 0) {
            subjectError.style.display = 'block';
            event.preventDefault(); // –û—Ç–º–µ–Ω—è–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.');
            return false; // –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ confirm
        } else {
            subjectError.style.display = 'none';
        }

        // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        if (!confirm('–°—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ–¥–∞ –∏ —Å–µ–º–µ—Å—Ç—Ä–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–æ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é?')) {
            event.preventDefault();
            return false;
        }
        return true;
    }
</script>
</body>
</html>