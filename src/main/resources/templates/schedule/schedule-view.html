<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</title>
    <link rel="stylesheet" th:href="@{/css/schedule-view-style.css}"> </head>
<body>

<header class="page-header"> <div class="header-logo-title">
        <span class="page-logo"><span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span></span>
    </a>
</div>
    <div class="header-user-controls" sec:authorize="isAuthenticated()">
        <span class="username" sec:authentication="principal.username">User</span>
        <form th:action="@{/logout}" method="post" style="display: inline; margin-left: 15px;">
            <button type="submit" class="button-logout">–í—ã–π—Ç–∏</button>
        </form>
    </div>
</header>

<div class="schedule-page-wrapper">

    <nav class="filter-navigation-bar">
        <form th:action="@{/schedule}" method="get" class="filters-form">
            <select name="viewAcademicYear" onchange="this.form.submit()" class="form-control-filter">
                <option th:each="year : ${allAcademicYears}" th:value="${year}" th:text="${year}" th:selected="${year == currentAcademicYear}"></option>
            </select>
            <select name="viewSemester" onchange="this.form.submit()" class="form-control-filter">
                <option th:each="sem : ${allSemesters}" th:value="${sem}" th:text="${sem + ' —Å–µ–º–µ—Å—Ç—Ä'}" th:selected="${sem == currentSemester}"></option>
            </select>
            <select name="viewWeek" onchange="this.form.submit()" class="form-control-filter">
                <option th:each="wk : ${allWeeks}" th:value="${wk}" th:text="${wk + ' –Ω–µ–¥–µ–ª—è'}" th:selected="${wk == currentWeek}"></option>
            </select>
            <select name="filterGroupId" onchange="this.form.submit()" class="form-control-filter" th:if="${isAdmin}">
                <option value="">–í—Å–µ –≥—Ä—É–ø–ø—ã</option> <option th:each="group : ${allGroups}" th:value="${group.id}" th:text="${group.name}" th:selected="${currentGroupId != null and group.id == currentGroupId}"></option>
            </select>
            <button type="submit" class="filter-button">–§–∏–ª—å—Ç—Ä</button>
            <a th:href="@{/schedule}" class="reset-button">–°–±—Ä–æ—Å</a>
        </form>
        <div class="semester-dates-info" th:if="${semesterStartDateDisplay != null and semesterEndDateDisplay != null}">
            <span>–ù–∞—á–∞–ª–æ —Å–µ–º–µ—Å—Ç—Ä–∞: <strong th:text="${semesterStartDateDisplay}"></strong></span>
            <span>–ö–æ–Ω–µ—Ü —Å–µ–º–µ—Å—Ç—Ä–∞: <strong th:text="${semesterEndDateDisplay}"></strong></span>
        </div>
    </nav>

    <main class="schedule-content-area">
        <div class="schedule-week-navigation">
            <a th:href="@{/schedule(viewAcademicYear=${currentAcademicYear}, viewSemester=${currentSemester}, viewWeek=${currentWeek - 1}, filterGroupId=${currentGroupId})}"
               th:classappend="${currentWeek <= 1 ? 'disabled' : ''}" class="week-nav-button prev-week">
                <span class="icon">‚¨ÖÔ∏è</span> –ü—Ä–µ–¥.
            </a>
            <span class="current-week-display" th:text="${'–ù–µ–¥–µ–ª—è ' + currentWeek + ': ' + weekDateRange}">26.05 - 01.06</span>
            <a th:href="@{/schedule(viewAcademicYear=${currentAcademicYear}, viewSemester=${currentSemester}, viewWeek=${currentWeek + 1}, filterGroupId=${currentGroupId})}"
               th:classappend="${currentWeek >= WEEKS_IN_SEMESTER ? 'disabled' : ''}" class="week-nav-button next-week">
                –°–ª–µ–¥. <span class="icon">‚û°Ô∏è</span>
            </a>
        </div>

        <div th:if="${successMessage}" class="message success-message">
            <span class="icon">üéâ </span><span th:text="${successMessage}"></span>
        </div>
        <div th:if="${errorMessage}" class="message error-message">
            <span class="icon">‚ùó </span><span th:text="${errorMessage}"></span>
        </div>

        <h2 class="view-title-header" th:text="${viewTitle}" style="text-align: center; margin-bottom: 20px; font-size: 1.6em; color: var(--primary-color);"></h2>


        <div class="schedule-grid-wrapper">
            <table class="schedule-table">
                <thead>
                <tr>
                    <th class="time-column-header">–í—Ä–µ–º—è \ –î–µ–Ω—å</th>
                    <th th:each="day : ${displayDaysOrder}" class="day-column-header">
                        <span th:text="${day.getDisplayName(T(java.time.format.TextStyle).FULL, T(java.util.Locale).forLanguageTag('ru'))}"></span><br/>
                        <span class="date-in-header" th:text="${weekDayDatesMap.get(day)}"></span>
                    </th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="lessonNum : ${lessonNumbers}" th:if="${lessonStartTimes.containsKey(lessonNum)}">
                    <td class="time-slot-cell">
                        <strong th:text="${lessonNum + ' –ø–∞—Ä–∞'}"></strong>
                        <span class="lesson-time-display">
                            <span th:text="${#temporals.format(lessonStartTimes.get(lessonNum), 'HH:mm')}"></span> -
                            <span th:text="${#temporals.format(lessonStartTimes.get(lessonNum).plusMinutes(lessonDuration), 'HH:mm')}"></span>
                        </span>
                    </td>
                    <td th:each="day : ${displayDaysOrder}" class="schedule-data-cell">
                        <div th:with="lessonsForSlot=${scheduleByDayAndLesson != null and scheduleByDayAndLesson.get(day) != null ? scheduleByDayAndLesson.get(day).get(lessonNum) : null}">
                            <div th:if="${lessonsForSlot != null and !lessonsForSlot.isEmpty()}" class="lessons-in-slot">
                                <div th:each="entry : ${lessonsForSlot}" class="schedule-entry-item">
                                    <strong th:text="${entry.subject.name}">–ü—Ä–µ–¥–º–µ—Ç</strong>
                                    <span th:text="${'–ê—É–¥: ' + entry.room.roomNumber}">–ê—É–¥.</span>
                                    <span th:if="${entry.subject.teacher != null}" th:text="${entry.subject.teacher.fullName}">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</span>
                                    <span th:if="${isAdmin and entry.group != null}" th:text="${'–ì—Ä: ' + entry.group.name}">–ì—Ä—É–ø–ø–∞</span>
                                </div>
                            </div>
                            <div th:if="${lessonsForSlot == null or lessonsForSlot.isEmpty()}" class="empty-slot-placeholder">
                            </div>
                        </div>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(lessonNumbers) or #lists.isEmpty(scheduleByDayAndLesson) and !errorMessage}">
                    <td th:colspan="${#lists.size(displayDaysOrder) + 1}" class="empty-table-message" style="height: 200px;">
                        –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –µ—â–µ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ.
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </main>
</div>
</body>
</html>